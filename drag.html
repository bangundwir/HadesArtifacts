<!doctype html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Unggah, Tampilkan, dan Kelola File dan Folder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/highlight.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/styles/default.min.css"
    />
    <style>
      .scrollbar-custom::-webkit-scrollbar {
        width: 8px;
      }
      .scrollbar-custom::-webkit-scrollbar-track {
        background: #f1f1f1;
      }
      .scrollbar-custom::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
      }
      .scrollbar-custom::-webkit-scrollbar-thumb:hover {
        background: #555;
      }
      .drag-handle {
        cursor: move;
        display: none;
      }
      .file-container.dragging {
        opacity: 0.5;
        background-color: #f1f1f1;
        border: 1px dashed #888;
      }
      .sortable-ghost {
        opacity: 0.4;
      }
      .file-container {
        transition: all 0.3s ease-in-out;
      }
    </style>
  </head>
  <body class="bg-gray-100 min-h-screen p-8">
    <div class="max-w-4xl mx-auto bg-white shadow-xl rounded-lg p-6">
      <h1 class="text-3xl font-bold mb-6 text-center text-gray-800">
        Unggah, Tampilkan, dan Kelola File dan Folder
      </h1>
      <div
        id="dropZone"
        class="border-4 border-dashed border-gray-300 rounded-lg p-8 mb-6 text-center"
      >
        <p class="text-gray-600 mb-2">
          Seret dan lepas file atau folder di sini atau
        </p>
        <div class="flex justify-center space-x-4">
          <div>
            <input
              type="file"
              id="fileInput"
              multiple
              class="hidden"
              onchange="handleFiles(this.files)"
            />
            <label
              for="fileInput"
              class="cursor-pointer bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition duration-300 inline-block"
            >
              Pilih File
            </label>
          </div>
          <div>
            <input
              type="file"
              id="folderInput"
              webkitdirectory
              directory
              multiple
              class="hidden"
              onchange="handleFiles(this.files)"
            />
            <label
              for="folderInput"
              class="cursor-pointer bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 transition duration-300 inline-block"
            >
              Pilih Folder
            </label>
          </div>
        </div>
      </div>
      <div class="flex space-x-4 mb-6">
        <button
          id="mergeButton"
          onclick="mergeAndCopy()"
          class="flex-1 bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 transition duration-300"
        >
          Gabung & Salin Semua
        </button>
        <button
          id="deleteSelectedButton"
          onclick="deleteSelected()"
          class="flex-1 bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition duration-300"
        >
          Hapus File Terpilih
        </button>
        <button
          id="toggleDragModeButton"
          onclick="toggleDragMode()"
          class="flex-1 bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600 transition duration-300"
        >
          Mode Seret
        </button>
        <button
          id="clearStorageButton"
          onclick="clearLocalStorage()"
          class="flex-1 bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600 transition duration-300"
        >
          Hapus Penyimpanan
        </button>
      </div>
      <div id="fileList" class="mb-6"></div>
      <div id="previewContainer" class="hidden mb-6">
        <h2 class="text-2xl font-semibold mb-3 text-gray-700">
          Preview Gabungan
        </h2>
        <pre
          id="mergePreview"
          class="bg-gray-100 p-4 rounded-lg max-h-96 overflow-y-auto scrollbar-custom text-sm"
        ></pre>
        <p id="charCount" class="mt-2 text-gray-600"></p>
      </div>
      <div id="folderGroups" class="mt-6 space-y-4"></div>
    </div>

    <script>
      let allFiles = [];
      let dragMode = false;

      document.addEventListener("DOMContentLoaded", () => {
        loadFromLocalStorage();
        initDropZone();
        enableDragging();
      });

      function initDropZone() {
        const dropZone = document.getElementById("dropZone");

        ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
          dropZone.addEventListener(eventName, preventDefaults, false);
          document.body.addEventListener(eventName, preventDefaults, false);
        });

        ["dragenter", "dragover"].forEach((eventName) => {
          dropZone.addEventListener(eventName, highlight, false);
        });

        ["dragleave", "drop"].forEach((eventName) => {
          dropZone.addEventListener(eventName, unhighlight, false);
        });

        dropZone.addEventListener("drop", handleDrop, false);
      }

      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }

      function highlight() {
        dropZone.classList.add("bg-blue-100");
      }

      function unhighlight() {
        dropZone.classList.remove("bg-blue-100");
      }

      async function handleDrop(e) {
        const items = e.dataTransfer.items;
        const files = await getAllFileEntries(items);
        handleFiles(files);
      }

      async function getAllFileEntries(dataTransferItems) {
        let fileEntries = [];
        let pendingPromises = [];

        function traverseFileTree(item, path = "") {
          if (item.isFile) {
            const promise = new Promise((resolve) => {
              item.file((file) => {
                file.fullPath = path + file.name;
                fileEntries.push(file);
                resolve();
              });
            });
            pendingPromises.push(promise);
          } else if (item.isDirectory) {
            const dirReader = item.createReader();
            const promise = new Promise((resolve) => {
              dirReader.readEntries((entries) => {
                const entriesPromises = entries.map((entry) =>
                  traverseFileTree(entry, path + item.name + "/"),
                );
                Promise.all(entriesPromises).then(resolve);
              });
            });
            pendingPromises.push(promise);
          }
        }

        for (let i = 0; i < dataTransferItems.length; i++) {
          const item = dataTransferItems[i].webkitGetAsEntry();
          if (item) {
            traverseFileTree(item);
          }
        }

        await Promise.all(pendingPromises);
        return fileEntries;
      }

      function handleFiles(files) {
        const fileList = document.getElementById("fileList");

        if (files.length > 0) {
          fileList.innerHTML = `<p class="text-gray-600 mb-2">File terpilih:</p>`;
          for (let file of files) {
            const relativePath =
              file.fullPath || file.webkitRelativePath || file.name;
            fileList.innerHTML += `<span class="inline-block bg-gray-200 rounded-full px-3 py-1 text-sm font-semibold text-gray-700 mr-2 mb-2">${relativePath}</span>`;
          }
        }

        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          const relativePath =
            file.fullPath || file.webkitRelativePath || file.name;

          const disallowedExtensions = ['ico', 'svg', 'jpg', 'jpeg', 'png', 'gif'];
          const fileExtension = relativePath.split('.').pop().toLowerCase();
          if (disallowedExtensions.includes(fileExtension)) {
            alert(`File dengan ekstensi .${fileExtension} tidak diperbolehkan: ${relativePath}`);
            continue;
          }

          processFile(file, relativePath);
        }
      }

      function processFile(file, relativePath) {
        const reader = new FileReader();
        reader.onload = function (e) {
          const content = e.target.result;
          allFiles.push({ name: relativePath, content: content });
          updateFolderGroups();
          updateMergePreview();
          saveToLocalStorage();
        };
        reader.onerror = function () {
          alert(`Gagal membaca file: ${file.name}`);
        };
        reader.readAsText(file);
      }

      function updateFolderGroups() {
        const folderGroups = document.getElementById("folderGroups");
        folderGroups.innerHTML = "";
        const groupedFiles = groupFilesByFolder();

        for (const folder in groupedFiles) {
          const groupContainer = document.createElement("div");
          groupContainer.className = "bg-gray-200 rounded-lg p-4 shadow";
          groupContainer.setAttribute("data-folder", folder);

          const folderHeader = document.createElement("div");
          folderHeader.className = "flex justify-between items-center mb-2";
          folderHeader.innerHTML = `
            <strong class="text-lg text-gray-800">${folder}</strong>
            <button class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600 transition duration-300" onclick="deleteFolder('${folder}')">Hapus Folder</button>
          `;

          const filesContainer = document.createElement("div");
          filesContainer.className = "space-y-2";

          groupedFiles[folder].forEach(file => {
            const fileElem = createFileElement(file);
            filesContainer.appendChild(fileElem);
          });

          groupContainer.appendChild(folderHeader);
          groupContainer.appendChild(filesContainer);
          folderGroups.appendChild(groupContainer);
        }
      }

      function groupFilesByFolder() {
        const groupedFiles = {};
        allFiles.forEach(file => {
          const folder = file.name.substring(0, file.name.lastIndexOf("/") + 1) || "Root";
          if (!groupedFiles[folder]) {
            groupedFiles[folder] = [];
          }
          groupedFiles[folder].push(file);
        });
        return groupedFiles;
      }

      function createFileElement(file) {
        const fileElem = document.createElement("div");
        fileElem.className = "bg-white shadow rounded-lg p-4 file-container";
        fileElem.setAttribute("data-filename", file.name);
        fileElem.setAttribute("draggable", "true");

        fileElem.addEventListener("dragstart", (e) => {
          fileElem.classList.add("dragging");
          e.dataTransfer.setData("text/plain", file.name);
        });

        fileElem.addEventListener("dragend", () => {
          fileElem.classList.remove("dragging");
        });

        const fileHeader = document.createElement("div");
        fileHeader.className = "flex justify-between items-center mb-2";
        fileHeader.innerHTML = `
          <div class="flex items-center">
            <span class="drag-handle hidden mr-2 cursor-move">&#9776;</span>
            <input type="checkbox" class="mr-2 file-checkbox" data-filename="${file.name}">
            <strong class="text-lg text-gray-800">${file.name}</strong>
          </div>
          <button class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600 transition duration-300" onclick="copyFile('${file.name}')">Salin</button>
          <button class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600 transition duration-300" onclick="deleteFile('${file.name}')">Hapus</button>
        `;

        const fileContentElem = document.createElement("pre");
        fileContentElem.className = "whitespace-pre-wrap break-all mt-2 p-2 bg-gray-100 rounded max-h-40 overflow-y-auto scrollbar-custom text-sm";
        fileContentElem.textContent = file.content;

        fileElem.appendChild(fileHeader);
        fileElem.appendChild(fileContentElem);

        applySyntaxHighlighting(fileContentElem, file.name);

        return fileElem;
      }

      function deleteFolder(folder) {
        allFiles = allFiles.filter(file => !file.name.startsWith(folder));
        updateFolderGroups();
        updateMergePreview();
        saveToLocalStorage();
      }

      function updateMergePreview() {
        const previewContainer = document.getElementById("previewContainer");
        const mergePreview = document.getElementById("mergePreview");
        const charCount = document.getElementById("charCount");
        if (allFiles.length > 0) {
          let mergedContent = allFiles
            .map((file) => `${file.name}\n${file.content}`)
            .join("\n\n");
          mergePreview.textContent = mergedContent;
          previewContainer.classList.remove("hidden");
          charCount.textContent = `Total karakter: ${mergedContent.length}`;
        } else {
          previewContainer.classList.add("hidden");
        }
      }

      function mergeAndCopy() {
        if (allFiles.length === 0) {
          alert("Silakan unggah file terlebih dahulu.");
          return;
        }

        let mergedContent = allFiles
          .map((file) => `${file.name}\n${file.content}`)
          .join("\n\n");
        navigator.clipboard.writeText(mergedContent).then(() => {
          alert("Semua file telah digabung dan disalin!");
        });
      }

      function copyFile(fileName) {
        const file = allFiles.find((f) => f.name === fileName);
        if (file) {
          const fullContent = `${file.name}\n${file.content}`;
          navigator.clipboard.writeText(fullContent).then(() => {
            alert("File disalin!");
          });
        }
      }

      function deleteFile(fileName) {
        allFiles = allFiles.filter((file) => file.name !== fileName);
        updateFolderGroups();
        updateMergePreview();
        saveToLocalStorage();
      }

      function deleteSelected() {
        const selectedCheckboxes = document.querySelectorAll(
          ".file-checkbox:checked",
        );
        if (selectedCheckboxes.length === 0) {
          alert("Pilih file yang ingin dihapus terlebih dahulu.");
          return;
        }
        selectedCheckboxes.forEach((checkbox) => {
          deleteFile(checkbox.getAttribute("data-filename"));
        });
      }

      function saveToLocalStorage() {
        localStorage.setItem("allFiles", JSON.stringify(allFiles));
      }

      function loadFromLocalStorage() {
        const savedFiles = localStorage.getItem("allFiles");
        if (savedFiles) {
          allFiles = JSON.parse(savedFiles);
          updateFolderGroups();
          updateMergePreview();
        }
      }

      function clearLocalStorage() {
        localStorage.removeItem("allFiles");
        allFiles = [];
        updateFolderGroups();
        updateMergePreview();
        alert("Penyimpanan lokal telah dihapus.");
        location.reload();
      }

      function toggleDragMode() {
        dragMode = !dragMode;
        const dragHandles = document.querySelectorAll(".drag-handle");
        const toggleButton = document.getElementById("toggleDragModeButton");

        if (dragMode) {
          dragHandles.forEach((handle) => handle.classList.remove("hidden"));
          toggleButton.textContent = "Matikan Mode Seret";
          toggleButton.classList.remove("bg-yellow-500", "hover:bg-yellow-600");
          toggleButton.classList.add("bg-blue-500", "hover:bg-blue-600");
          enableDragging();
          initSortable();
        } else {
          dragHandles.forEach((handle) => handle.classList.add("hidden"));
          toggleButton.textContent = "Mode Seret";
          toggleButton.classList.remove("bg-blue-500", "hover:bg-blue-600");
          toggleButton.classList.add("bg-yellow-500", "hover:bg-yellow-600");
        }
      }

      function enableDragging() {
        const fileContainers = document.querySelectorAll(".file-container");

        fileContainers.forEach((container) => {
          container.setAttribute("draggable", true);

          container.addEventListener("dragstart", (e) => {
            container.classList.add("dragging");
            e.dataTransfer.setData("text/plain", container.dataset.filename);
          });

          container.addEventListener("dragend", () => {
            container.classList.remove("dragging");
          });
        });
      }

      function initSortable() {
        const folderGroups = document.getElementById("folderGroups");

        Sortable.create(folderGroups, {
          handle: ".drag-handle",
          animation: 150,
          onEnd: function (evt) {
            const items = Array.from(evt.to.children);
            allFiles = items.map((item) => {
              const filename = item.getAttribute("data-filename");
              return allFiles.find((file) => file.name === filename);
            });
            updateFolderGroups();
            saveToLocalStorage();
          },
        });
      }

      function applySyntaxHighlighting(element, fileName) {
        const extension = fileName.split(".").pop().toLowerCase();
        let language;

        switch (extension) {
          case "js":
          case "ts":
            language = "javascript";
            break;
          case "html":
            language = "html";
            break;
          case "css":
            language = "css";
            break;
          case "py":
            language = "python";
            break;
          case "json":
            language = "json";
            break;
          default:
            language = "plaintext";
        }

        element.classList.add(`language-${language}`);
        hljs.highlightElement(element);
      }

      document.addEventListener("DOMContentLoaded", (event) => {
        document.querySelectorAll("pre").forEach((block) => {
          hljs.highlightElement(block);
        });
        initDropZone();
        loadFromLocalStorage();
      });
    </script>
  </body>
</html>
